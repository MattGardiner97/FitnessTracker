@model FitnessTracker.Controllers.BodyweightSummaryModel

@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <script src="~/js/Bodyweight/summary.js"></script>
}

@{
    ViewData["Title"] = "Bodyweight";

    IEnumerable<BodyweightRecord> allRecords = Model.Records?.OrderByDescending(record => record.Date);
    IEnumerable<BodyweightRecord> currentWeekRecords = allRecords.Where(record => record.Date >= DateTime.Today.AddDays(-7));
    IEnumerable<BodyweightRecord> currentMonthRecords = allRecords.Where(record => record.Date >= DateTime.Today.AddDays(-28));

    BodyweightRecord mostRecentWeight = allRecords.FirstOrDefault();

    float currentWeekProgress = 0;
    float currentWeekAverage = 0;
    float currentMonthProgress = 0;
    float currentMonthAverage = 0;
    float allTimeProgress = 0;
    float allTimeAverage = 0;
    float distanceToTarget = 0;
    float dailyProgressNeeded = 0;
    float weeklyProgressNeeded = 0;

    if (currentWeekRecords.Count() > 0)
    {
        currentWeekProgress = currentWeekRecords.First().Weight - currentWeekRecords.Last().Weight;
        currentWeekAverage = currentWeekProgress / 7;
    }


    if (currentMonthRecords.Count() > 0)
    {
        currentMonthProgress = currentMonthRecords.First().Weight - currentMonthRecords.Last().Weight;
        currentMonthAverage = currentMonthProgress / 28;
    }

    if (allRecords.Count() > 0)
    {
        allTimeProgress = allRecords.First().Weight - allRecords.Last().Weight;
        allTimeAverage = allTimeProgress / ((float)(allRecords.First().Date - allRecords.Last().Date).TotalDays) * 7;
    }


    distanceToTarget = 0;
    if (Model.Target != null && mostRecentWeight != null)
        distanceToTarget = Model.Target.TargetWeight - mostRecentWeight.Weight;
    dailyProgressNeeded = Model.Target == null ? 0 : (float)(distanceToTarget / (Model.Target.TargetDate - DateTime.Today).TotalDays);
    weeklyProgressNeeded = dailyProgressNeeded * 7;


}

<h1>Bodyweight Summary</h1>

<div>
    <a asp-controller="Bodyweight" asp-action="EditRecords" class="btn btn-primary">Edit Bodyweights</a>
    <a asp-controller="Bodyweight" asp-action="EditTarget" class="btn btn-primary">Edit Target</a>
</div>

@if (mostRecentWeight == null || mostRecentWeight.Date != DateTime.Today)
{
<div class="row">
    <div class="col-3">
        <div class="alert alert-info mt-2">
            <h5 class="ml-3">Add Today's Weight</h5>

            <form asp-action="AddTodayWeight" method="post" class="ml-3 mr-3">
                <div class="input-group form-inline ">
                    <input type="number" min="0" max="200" name="Weight" step="1" class="form-control mr-1" />
                    <input type="submit" value="Save" class="btn btn-primary" />
                </div>
            </form>
        </div>
    </div>
</div>
}


<div id="WeekGraphData" class="d-none">
    @foreach (var record in currentWeekRecords)
    {
        <div data-date="@record.Date.ToString("yyyy-MM-dd")" data-weight="@record.Weight.ToString("F2")"></div>
    }
</div>

<div id="MonthGraphData" class="d-none">
    @foreach (var record in currentMonthRecords)
    {
        <div data-date="@record.Date.ToString("yyyy-MM-dd")" data-weight="@record.Weight.ToString("F2")"></div>
    }
</div>

<div class="row my-3">
    <div class="col">
        <div class="card mheight-100">
            <div class="card-header">
                <h6 class="card-subtitle">Most Recent Bodyweight</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @(mostRecentWeight == null ? "0" : mostRecentWeight.Weight.ToString("F2"))kg
                    </h4>
                    <div class="card-text text-center">
                        @(mostRecentWeight?.Date.ToString("d"))
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="col">
        <div class="card my-2">
            <div class="card-header">
                <h6 class="card-subtitle">This Week's Progress</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @(currentWeekProgress >= 0 ? "+" : "")@(currentWeekProgress.ToString("F2"))kg
                    </h4>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h6 class="card-subtitle">Daily Average (This Week)</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @(currentWeekAverage >= 0 ? "+" : "")@(currentWeekAverage.ToString("F2"))kg
                    </h4>
                </div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card my-2">
            <div class="card-header">
                <h6 class="card-subtitle">Current Month's Progress</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @(currentMonthProgress >= 0 ? "+" : "")@(currentMonthProgress.ToString("F2"))kg
                    </h4>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h6 class="card-subtitle">Daily Average (This Month)</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @(currentMonthAverage >= 0 ? "+" : "")@(currentMonthAverage.ToString("F2"))kg
                    </h4>
                </div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card my-2">
            <div class="card-header">
                <h6 class="card-subtitle">All Time Progress</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @(allTimeProgress >= 0 ? "+" : "")@(allTimeProgress.ToString("F2"))kg
                    </h4>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h6 class="card-subtitle">Weekly Average (All Time)</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @(allTimeAverage >= 0 ? "+" : "")@(allTimeAverage.ToString("F2"))kg
                    </h4>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col">
        <div class="card mheight-100">
            <div class="card-header">
                <h6 class="card-subtitle">Target Bodyweight</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @(Model.Target == null ? "0" : Model.Target.TargetWeight.ToString("F2"))kg
                    </h4>
                    <div class="card-text text-center">@(Model.Target.TargetDate.ToString("d"))</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card mheight-100">
            <div class="card-header">
                <h6 class="card-subtitle">Distance to Target</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @(distanceToTarget >= 0 ? "+" : "")@(distanceToTarget.ToString("F2"))kg
                    </h4>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card mheight-100">
            <div class="card-header">
                <h6 class="card-subtitle">Daily Progress Needed</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @(dailyProgressNeeded >= 0 ? "+" : "")@(dailyProgressNeeded.ToString("F2"))kg
                    </h4>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card mheight-100">
            <div class="card-header">
                <h6 class="card-subtitle">Weekly Progress Needed</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @(weeklyProgressNeeded >= 0 ? "+" : "")@(weeklyProgressNeeded.ToString("F2"))kg
                    </h4>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col">
        <h2 class="text-center">This Week</h2>
        <canvas id="WeekGraph" style="max-width:100%;">
        </canvas>
    </div>
    <div class="col">
        <h2 class="text-center">This Month</h2>
        <canvas id="MonthGraph" style="max-width:100%;">
        </canvas>
    </div>
</div>



