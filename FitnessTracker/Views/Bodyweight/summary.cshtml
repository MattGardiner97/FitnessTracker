@model FitnessTracker.Controllers.BodyweightSummaryModel

@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <script src="~/js/Bodyweight/summary.js"></script>
}

@{
    ViewData["Title"] = "Bodyweight";

    string FormatWeight(double D)
    {
        //Added this because of D = 0 results in "-+0.00kg". Most likely a floating point precision issue.
        if (D == -0)
            D = 0;

        var x = $"{Math.Round(D, 2).ToString("+0.00;-0.00")}kg";
        return x;
    }

    IEnumerable<BodyweightRecord> allRecords = Model.Records?.OrderByDescending(record => record.Date);
    IEnumerable<BodyweightRecord> currentWeekRecords = allRecords.Where(record => record.Date >= DateTime.Today.AddDays(-7));
    IEnumerable<BodyweightRecord> currentMonthRecords = allRecords.Where(record => record.Date >= DateTime.Today.AddDays(-28));

    BodyweightRecord mostRecentWeight = allRecords.FirstOrDefault();

    float currentWeekProgress = 0;
    float currentWeekAverage = 0;
    float currentMonthProgress = 0;
    float currentMonthAverage = 0;
    float allTimeProgress = 0;
    float allTimeAverage = 0;
    float distanceToTarget = 0;
    float dailyProgressNeeded = 0;
    float weeklyProgressNeeded = 0;

    if (currentWeekRecords.Count() > 0)
    {
        currentWeekProgress = currentWeekRecords.First().Weight - currentWeekRecords.Last().Weight;
        currentWeekAverage = currentWeekProgress / 7;
    }


    if (currentMonthRecords.Count() > 0)
    {
        currentMonthProgress = currentMonthRecords.First().Weight - currentMonthRecords.Last().Weight;
        currentMonthAverage = currentMonthProgress / 28;
    }

    if (allRecords.Count() > 0)
    {
        allTimeProgress = allRecords.First().Weight - allRecords.Last().Weight;
        allTimeAverage = allTimeProgress / ((float)(allRecords.First().Date - allRecords.Last().Date).TotalDays) * 7;
    }


    distanceToTarget = 0;
    if (Model.Target != null && mostRecentWeight != null)
        distanceToTarget = Model.Target.TargetWeight - mostRecentWeight.Weight;
    dailyProgressNeeded = Model.Target == null ? 0 : (float)(distanceToTarget / (Model.Target.TargetDate - DateTime.Today).TotalDays);
    weeklyProgressNeeded = dailyProgressNeeded * 7;


}

<div>
    <h2 class="d-inline">My Bodyweight</h2>
    <a asp-controller="Bodyweight" asp-action="EditRecords" class="font-weight-bold d-inline">+Add Bodyweights</a>
</div>

@if (mostRecentWeight == null || mostRecentWeight.Date != DateTime.Today)
{
    <div class="row">
        <div class="col-3">
            <div class="alert alert-info mt-2">
                <h5 class="ml-3">Add Today's Weight</h5>

                <form asp-action="AddTodayWeight" method="post" class="ml-3 mr-3">
                    <div class="input-group form-inline ">
                        <input type="number" min="0" max="200" name="Weight" step="1" class="form-control mr-1" />
                        <input type="submit" value="Save" class="btn btn-primary" />
                    </div>
                </form>
            </div>
        </div>
    </div>
}


<div class="row my-3">
    <div class="col">
        <div class="card mheight-100">
            <div class="card-header py-3">
                <h6 class="card-subtitle">Most Recent Bodyweight</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @(mostRecentWeight == null ? "0" : mostRecentWeight.Weight.ToString("F2"))kg
                    </h4>
                    <div class="card-text text-center">
                        @(mostRecentWeight?.Date.ToString("d"))
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="col">
        <div class="card mb-2">
            <div class="card-header py-3">
                <h6 class="card-subtitle">This Week's Progress</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @FormatWeight(currentWeekProgress)
                    </h4>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header py-3">
                <h6 class="card-subtitle">Daily Average (This Week)</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @FormatWeight(currentWeekAverage)
                    </h4>
                </div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card mb-2">
            <div class="card-header py-3">
                <h6 class="card-subtitle">Current Month's Progress</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @FormatWeight(currentMonthProgress)
                    </h4>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header py-3">
                <h6 class="card-subtitle">Daily Average (This Month)</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @FormatWeight(currentMonthAverage)
                    </h4>
                </div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card mb-2">
            <div class="card-header py-3">
                <h6 class="card-subtitle">All Time Progress</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @FormatWeight(allTimeProgress)
                    </h4>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header py-3">
                <h6 class="card-subtitle">Weekly Average (All Time)</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @FormatWeight(allTimeAverage)
                    </h4>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col">
        <div class="card mheight-100">
            <div class="card-header py-3">

                <h6 class="card-subtitle d-">Target Bodyweight <i class="far fa-edit float-right" style="cursor:pointer" data-toggle="modal" data-target="#TargetModal">Edit</i></h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center" id="TargetWeight" data-target="@(Model.Target == null ? 0 : Model.Target.TargetWeight)">
                        @(Model.Target == null ? "0" : Model.Target.TargetWeight.ToString("F2"))kg
                    </h4>
                    <div class="card-text text-center">@(Model.Target.TargetDate.ToString("d"))</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card mheight-100">
            <div class="card-header py-3">
                <h6 class="card-subtitle">Distance to Target</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @FormatWeight(distanceToTarget)
                    </h4>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card mheight-100">
            <div class="card-header py-3">
                <h6 class="card-subtitle">Daily Progress Needed</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @FormatWeight(dailyProgressNeeded)
                    </h4>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card mheight-100">
            <div class="card-header py-3">
                <h6 class="card-subtitle">Weekly Progress Needed</h6>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="w-100">
                    <h4 class="card-title text-center">
                        @FormatWeight(weeklyProgressNeeded)
                    </h4>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col">
        <h2 class="text-center">This Week</h2>
        <canvas id="WeekGraph" style="max-width:100%;">
        </canvas>
    </div>
    <div class="col">
        <h2 class="text-center">This Month</h2>
        <canvas id="MonthGraph" style="max-width:100%;">
        </canvas>
    </div>
</div>



<div class="modal fade" id="TargetModal" tabindex="-1" aria-labelledby="TargetModal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Edit Target</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form asp-controller="Bodyweight" asp-action="EditTarget" method="post">

                <div class="modal-body">


                    <div class="form-group">
                        <label>Weight</label>
                        <input class="form-control" name="TargetWeight" type="number" min="1" max="300" />
                    </div>

                    <div class="form-group">
                        <label>Target Date</label>
                        <input class="form-control" name="TargetDate" type="date" />
                    </div>



                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <input type="submit" class="btn btn-primary" value="Save">
                </div>
            </form>

        </div>
    </div>
</div>
